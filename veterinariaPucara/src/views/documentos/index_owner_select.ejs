<%- include('../layouts/layout', { body: `
<h2>Documentos</h2>
<p class="text-muted">
  Busca documentos por propietario para ver recetas y presupuestos.
</p>

<div class="card shadow-sm" style="max-width: 520px">
  <div class="card-body">
    <label style="display: block; margin-bottom: 8px"
      ><strong>Propietario</strong></label
    >
    <div class="position-relative">
      <input
        id="ownerInput"
        class="form-control"
        placeholder="Escribe el nombre del propietario..."
        autocomplete="off"
      />
      <div
        id="results"
        class="list-group"
        style="
          position: absolute;
          z-index: 10;
          width: 100%;
          max-height: 240px;
          overflow: auto;
          display: none;
        "
      ></div>
    </div>

    <div class="d-flex gap-2 mt-3">
      <button class="btn" id="openBtn" disabled>Abrir documentos</button>
      <a href="/propietarios" class="btn btn--outline"
        >Ver lista de propietarios</a
      >
    </div>
  </div>
</div>

<script>
  const input = document.getElementById("ownerInput");
  const results = document.getElementById("results");
  const openBtn = document.getElementById("openBtn");

  let selected = null;
  let t;

  function render(items) {
    results.innerHTML = "";
    if (!items.length) {
      results.style.display = "none";
      return;
    }
    items.forEach((it) => {
      const a = document.createElement("a");
      a.href = "#";
      a.className = "list-group-item list-group-item-action";
      a.textContent = it.name + "  (ID: " + it.id + ")";
      a.onclick = (e) => {
        e.preventDefault();
        selected = it;
        input.value = it.name;
        openBtn.disabled = false;
        results.style.display = "none";
      };
      results.appendChild(a);
    });
    results.style.display = "block";
  }

  async function searchOwners(q) {
    const r = await fetch("/api/owners?q=" + encodeURIComponent(q));
    const data = await r.json();
    render(data);
  }

  input.addEventListener("focus", () => searchOwners(input.value));
  input.addEventListener("input", () => {
    selected = null;
    openBtn.disabled = true;
    clearTimeout(t);
    t = setTimeout(() => searchOwners(input.value), 250);
  });

  document.addEventListener("click", (e) => {
    if (!results.contains(e.target) && e.target !== input) {
      results.style.display = "none";
    }
  });

  openBtn.addEventListener("click", () => {
    if (selected) {
      location.href = "/documentos/owner/" + selected.id;
    }
  });
</script>
` }) %>
